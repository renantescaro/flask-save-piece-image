<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div>
        <canvas id="myCanvas"></canvas>
        <canvas id="canvasTarget"></canvas>
    </div>
    <div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Index</th>
                    <th>Placa</th>
                    <th>Atual</th>
                    <th>Feita</th>
                </tr>
            </thead>
            <tbody>
                {% for index in range(0, qtd) %}
                    {% if lista_images[index]['read'] == 'n' %}
                    <tr>
                        <td>{{index}}</td>
                        <td>{{lista_images[index]['file_name']}}</td>
                        <td><input type="checkbox" onclick='setImage("{{lista_images[index]["file_name"]}}", "{{index}}")'></td>
                        <td><input type="checkbox"></td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // dimensões do corte
        var widthCut = 60
        var heightCut = 100

        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        ctx.canvas.width = 600
        ctx.canvas.height = 200

        var canvasTarget = document.getElementById("canvasTarget");
        var ctxCanvasTarget = canvasTarget.getContext("2d");
        ctxCanvasTarget.canvas.width = widthCut
        ctxCanvasTarget.canvas.height = heightCut

        var indexImg = ''
        var nameImg = ''
        const image = new Image();

        function setImage(nameImgSelected='', index){
            image.src = "/static/images/"+nameImgSelected;
            indexImg = index
            nameImg = nameImgSelected
    
            onmousemove = function drawRectangleAroundMouse(e){
                console.log("mouse location:", e.clientX, e.clientY)
    
                ctx.drawImage(image, 0, 0)
                ctx.strokeStyle = "green";
                ctx.strokeRect(e.clientX-50, e.clientY-50, widthCut, heightCut);
            }
        }

        canvas.onclick = function cropImageWithRectangle(e){
            console.log('clicou!')

            let image2 = new Image();
            image2.src = image.src
            ctxCanvasTarget.drawImage(
                image2,
                e.clientX-50, // começa a cortar
                e.clientY-50,
                widthCut, // comprimento do corte, começa acima
                heightCut,
                0, // inicio do canvas atual
                0,
                widthCut,
                heightCut
            );
        }

        function checkCharacter(character, plate){
            if (character != null && plate != null){
                return plate.toLowerCase().includes(character.toLowerCase())
            }
            return false
        }

        document.addEventListener('keydown', (event) => {
            const keyName = event.key;
            if (keyName === 's') {
                character = prompt('Letra: ', '')
                if (checkCharacter(character, nameImg)){
                    var a = document.createElement('a')
                    a.setAttribute('download', character+'_'+indexImg);
                    a.setAttribute('href', canvasTarget.toDataURL("image/png"));
                    a.click();
                    return
                }

                else{
                    alert('Caracter "'+character+'"" não encontrado na placa "'+nameImg+'"')
                }
            }
        })

    </script>
</body>
</html>
